apiVersion: v1
kind: ConfigMap
metadata:
  name: benchmark-scripts-full
  namespace: <YOUR_NAMESPACE>  # REQUIRED: Replace with your namespace
data:
  # K8s Launcher Script
  # Downloads ALL scripts from GitHub (including run-benchmark.sh)
  # This ensures K8s uses IDENTICAL scripts as local/docker execution
  # Single source of truth: benchmarks/ directory in GitHub
  run-benchmark.sh: |
    #!/bin/bash
    set -e

    # Configuration from environment variables
    MODEL_NAME="${MODEL_NAME:-facebook/opt-1.3b}"
    NUM_REPLICAS="${NUM_REPLICAS:-10}"
    MEM_POOL_SIZE="${MEM_POOL_SIZE:-8GB}"
    STORAGE_PATH="${STORAGE_PATH:-/models}"
    RESULTS_PATH="${RESULTS_PATH:-/results}"
    BENCHMARK_TYPE="${BENCHMARK_TYPE:-random}"
    GENERATE_PLOTS="${GENERATE_PLOTS:-false}"
    KEEP_ALIVE="${KEEP_ALIVE:-false}"
    BRANCH="${BRANCH:-claude/serverlessllm-docker-setup-01SxEhpoNSDpRQp1iKqWfyRS}"

    echo "============================================================"
    echo "ServerlessLLM K8s Benchmark Launcher"
    echo "============================================================"
    echo "Branch: $BRANCH"
    echo "Model: $MODEL_NAME"
    echo "Replicas: $NUM_REPLICAS"
    echo "Storage: $STORAGE_PATH"
    echo "Results: $RESULTS_PATH"
    echo ""

    # Create directories
    mkdir -p "$RESULTS_PATH" /tmp/benchmarks
    cd /tmp/benchmarks

    LOG_FILE="${RESULTS_PATH}/benchmark.log"

    # Set up logging
    exec 1> >(tee -a "$LOG_FILE")
    exec 2>&1

    echo "[$(date)] Installing curl if needed..."
    if ! command -v curl &> /dev/null; then
        apt-get update -qq && apt-get install -y -qq curl
    fi

    echo "[$(date)] Downloading ALL benchmark scripts from GitHub..."
    echo "This ensures K8s uses identical scripts as local/docker execution"
    echo ""

    # Download ALL scripts including the main orchestration script
    BASE_URL="https://raw.githubusercontent.com/ServerlessLLM/ServerlessLLM/${BRANCH}/benchmarks"

    curl -fsSL "${BASE_URL}/run-benchmark.sh" -o actual-run-benchmark.sh
    curl -fsSL "${BASE_URL}/download_models.py" -o download_models.py
    curl -fsSL "${BASE_URL}/test_loading.py" -o test_loading.py
    curl -fsSL "${BASE_URL}/benchmark_utils.py" -o benchmark_utils.py
    curl -fsSL "${BASE_URL}/generate_report.py" -o generate_report.py

    chmod +x actual-run-benchmark.sh generate_report.py

    echo "[$(date)] Scripts downloaded successfully"
    echo ""
    echo "[$(date)] Activating conda environment..."

    # Activate conda (required for serverlessllm/sllm image)
    if [ -f /opt/conda/etc/profile.d/conda.sh ]; then
        source /opt/conda/etc/profile.d/conda.sh
        conda activate worker || conda activate head
        echo "Environment: $(conda info --envs | grep '*' | awk '{print $1}')"
    fi

    echo "[$(date)] Installing Python dependencies..."
    pip install --quiet transformers torch accelerate tqdm sentencepiece || true
    echo ""

    # Set up cleanup trap for KEEP_ALIVE mode
    if [ "$KEEP_ALIVE" = "true" ]; then
        cleanup() {
            echo ""
            echo "============================================================"
            echo "Benchmark complete. KEEP_ALIVE=true, container staying alive"
            echo "Results are available at: $RESULTS_PATH"
            echo "============================================================"
            tail -f /dev/null
        }
        trap cleanup EXIT
    fi

    # Export all configuration for the actual script
    export MODEL_NAME
    export NUM_REPLICAS
    export MEM_POOL_SIZE
    export STORAGE_PATH
    export RESULTS_PATH
    export BENCHMARK_TYPE
    export GENERATE_PLOTS

    echo "============================================================"
    echo "Executing downloaded run-benchmark.sh"
    echo "This is the SAME script used for local/docker execution"
    echo "============================================================"
    echo ""

    # Execute the actual benchmark script from GitHub
    bash actual-run-benchmark.sh

    echo ""
    echo "============================================================"
    echo "K8s Benchmark Complete"
    echo "Results saved to: $RESULTS_PATH"
    echo "============================================================"
