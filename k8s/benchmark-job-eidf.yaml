apiVersion: batch/v1
kind: Job
metadata:
  generateName: sllm-benchmark-  # EIDF requires generateName (auto-generates unique names)
  namespace: <YOUR_NAMESPACE>  # REQUIRED: Replace with your namespace
  labels:
    app: sllm-benchmark
    kueue.x-k8s.io/queue-name: <YOUR_NAMESPACE>-user-queue  # REQUIRED: Replace with your namespace
spec:
  template:
    metadata:
      labels:
        app: sllm-benchmark
    spec:
      restartPolicy: Never

      containers:
      - name: benchmark
        # Use official ServerlessLLM image
        image: serverlessllm/sllm:latest  # Or: <YOUR_REGISTRY>/sllm-store:latest

        # Override command to run benchmark
        command: ["/bin/bash", "/scripts/run-benchmark.sh"]

        # Environment configuration
        envFrom:
        - configMapRef:
            name: benchmark-config

        # Additional env vars
        env:
        - name: PYTHONUNBUFFERED
          value: "1"
        # HF token for gated models (from secret)
        - name: HF_TOKEN
          valueFrom:
            secretKeyRef:
              name: <HF_SECRET>
              key: token
              optional: true  # Don't fail if secret doesn't exist
        # Uncomment to override defaults:
        # - name: MODEL_NAME
        #   value: "facebook/opt-6.7b"
        # - name: NUM_REPLICAS
        #   value: "20"

        # Resource requests (REQUIRED by EIDF)
        resources:
          requests:
            cpu: "<CPU_REQUEST>"
            memory: "<MEMORY_REQUEST>"
            nvidia.com/gpu: <GPU_COUNT>
          limits:
            cpu: "<CPU_LIMIT>"
            memory: "<MEMORY_LIMIT>"
            nvidia.com/gpu: <GPU_COUNT>

        # Volume mounts
        volumeMounts:
        - name: benchmark-scripts
          mountPath: /scripts
          readOnly: true
        - name: model-storage
          mountPath: /models
        - name: results
          mountPath: /results

      # Volumes
      volumes:
      # Scripts from ConfigMap
      - name: benchmark-scripts
        configMap:
          name: benchmark-scripts-full
          defaultMode: 0755

      # Model storage - using emptyDir (hostPath blocked by EIDF PodSecurity)
      # Note: emptyDir may use node local storage (including NVMe) depending on cluster config
      - name: model-storage
        emptyDir:
          sizeLimit: 2Ti  # Increased to 2TB for large model benchmarks

      # Results storage (temporary - copied out after completion)
      - name: results
        emptyDir: {}

      # Node selector for specific GPU (H100)
      nodeSelector:
        nvidia.com/gpu.product: 'NVIDIA-H100-80GB-HBM3'
