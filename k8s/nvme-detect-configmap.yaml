apiVersion: v1
kind: ConfigMap
metadata:
  name: nvme-detect-script
  namespace: <YOUR_NAMESPACE>  # REQUIRED: Replace with your namespace
data:
  detect-nvme.sh: |
    #!/bin/bash
    set -e

    echo "=== NVMe SSD Detection Script ==="
    echo "Timestamp: $(date)"
    echo "Hostname: $(hostname)"
    echo ""

    # Output file for debugging
    DEBUG_LOG="/debug/nvme-detection.log"
    mkdir -p /debug

    # Function to log to both stdout and file
    log() {
        echo "$1" | tee -a "$DEBUG_LOG"
    }

    log "=== NVMe SSD Detection Script ==="
    log "Timestamp: $(date)"
    log "Hostname: $(hostname)"
    log ""

    # Detect all NVMe devices
    log "--- Detecting NVMe Devices ---"
    if command -v nvme &> /dev/null; then
        log "nvme CLI tool found"
        nvme list 2>&1 | tee -a "$DEBUG_LOG" || log "nvme list command failed"
    else
        log "WARNING: nvme CLI tool not found, using alternative detection"
    fi

    log ""
    log "--- Block Devices (lsblk) ---"
    lsblk -o NAME,SIZE,TYPE,MOUNTPOINT,FSTYPE,MODEL | tee -a "$DEBUG_LOG"

    log ""
    log "--- NVMe Block Devices ---"
    NVME_DEVICES=$(ls /dev/nvme* 2>/dev/null || echo "")
    if [ -z "$NVME_DEVICES" ]; then
        log "ERROR: No NVMe devices found at /dev/nvme*"
        log "Available block devices:"
        ls -la /dev/ | grep -E "sd|nvme|vd" | tee -a "$DEBUG_LOG"
        exit 1
    fi

    log "Found NVMe devices:"
    echo "$NVME_DEVICES" | tee -a "$DEBUG_LOG"

    log ""
    log "--- NVMe Device Details ---"
    for dev in /dev/nvme*n1; do
        if [ -b "$dev" ]; then
            log "Device: $dev"
            log "  Size: $(blockdev --getsize64 $dev 2>/dev/null | awk '{print $1/1024/1024/1024 " GB"}' || echo 'unknown')"
            log "  Model: $(cat /sys/block/$(basename $dev)/device/model 2>/dev/null || echo 'unknown')"
            log "  Serial: $(cat /sys/block/$(basename $dev)/device/serial 2>/dev/null || echo 'unknown')"

            # Check if mounted
            MOUNT_POINT=$(lsblk -no MOUNTPOINT "$dev" 2>/dev/null | head -n1)
            if [ -n "$MOUNT_POINT" ]; then
                log "  Mount point: $MOUNT_POINT"
                log "  Available space: $(df -h $MOUNT_POINT | tail -n1 | awk '{print $4}')"
            else
                log "  Mount point: Not mounted"
            fi
            log ""
        fi
    done

    log "--- Storage Mount Points ---"
    df -h | tee -a "$DEBUG_LOG"

    log ""
    log "--- Checking Model Storage Path ---"
    MODEL_PATH="${MODEL_PATH:-/models}"
    log "Model storage path: $MODEL_PATH"

    if [ -d "$MODEL_PATH" ]; then
        log "  Path exists: YES"
        log "  Writable: $([ -w $MODEL_PATH ] && echo YES || echo NO)"
        log "  Space available: $(df -h $MODEL_PATH | tail -n1 | awk '{print $4}')"
        log "  Filesystem type: $(df -T $MODEL_PATH | tail -n1 | awk '{print $2}')"

        # Find which device this path is on
        DEVICE=$(df $MODEL_PATH | tail -n1 | awk '{print $1}')
        log "  Mounted from device: $DEVICE"

        # Check if it's on NVMe
        if echo "$DEVICE" | grep -q nvme; then
            log "  Storage type: NVMe SSD âœ“"

            # Performance info
            if [ -b "$DEVICE" ]; then
                SCHEDULER=$(cat /sys/block/$(basename $DEVICE | sed 's/p[0-9]*$//')/queue/scheduler 2>/dev/null || echo 'unknown')
                log "  I/O Scheduler: $SCHEDULER"
            fi
        else
            log "  WARNING: Storage type is NOT NVMe"
        fi

        # Test write performance (small test)
        log ""
        log "  Testing write performance..."
        TEST_FILE="$MODEL_PATH/.write_test_$$"
        if dd if=/dev/zero of=$TEST_FILE bs=1M count=100 2>&1 | tee -a "$DEBUG_LOG"; then
            rm -f $TEST_FILE
            log "  Write test: PASSED"
        else
            log "  Write test: FAILED"
        fi
    else
        log "  Path exists: NO"
        log "  ERROR: Model storage path does not exist!"
        exit 1
    fi

    log ""
    log "=== Detection Complete ==="
    log "Debug log saved to: $DEBUG_LOG"
    log ""

    # Set ownership if requested
    if [ -n "$CHOWN_USER" ]; then
        log "Setting ownership of $MODEL_PATH to $CHOWN_USER"
        chown -R $CHOWN_USER:$CHOWN_USER $MODEL_PATH 2>&1 | tee -a "$DEBUG_LOG" || true
    fi

    log "Initialization successful!"
